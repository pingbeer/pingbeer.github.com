
<!DOCTYPE html>

<html>
  <head>
    <title>Home</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="/public/css/bootstrap-3.3.6.min.css">
    <link rel="stylesheet" type="text/css" href="/public/css/font-awesome.min.css">
    <link rel="shortcut icon" type="image/png" href="/public/img/favicon.png">
    <script src="/public/js/jquery-2.2.4.min.js"></script>
    <script src="/public/js/bootstrap-3.3.6.min.js"></script>
		
    
      <link rel="stylesheet" type="text/css" href="/public/css/app.css">
    
    
  </head>
  <script type="text/javascript">
     
    var globalWidth = window.innerWidth;
    var radixNO = 12/320*globalWidth;
    document.documentElement.style.fontSize = radixNO + 'px';
     
    (function (doc, win) {
        var docEl = doc.documentElement,
            resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
            recalc = function () {
                var globalWidth = window.innerWidth;
                var clientWidth = docEl.clientWidth;
                if (!clientWidth) return;
                docEl.style.fontSize = 12 * (clientWidth / 320) + 'px';
            };
        if (!doc.addEventListener) return;
        win.addEventListener(resizeEvt, recalc, false);
        doc.addEventListener('DOMContentLoaded', recalc, false);
    })(document, window);
  </script>
  <body style="display: none;">


<div class="container row">
    <a id="go-back" href="javascript:history.go(-1);"><i class="fa fa-angle-left"></i></a>
	<div class="login_part col-xs-12">
		<legend class=""><h4>登录</h4></legend>
		<form id="send-code-form">
			<ul class="col-xs-12">
				<ol class="clearfix form-group">
					<label class="sr-only" for="input-mobile">手机号</label>
					<div class="col-xs-9">
						<div class="row input-group">
							<div class="input-group-addon">
								<i class="glyphicon glyphicon-phone"></i>
							</div>
							<input class="form-control" autocomplete="off" required placeholder="请输入您的手机号" type="tel" pattern="[0-9]{11}" title="请输入11位电话号码" id="input-mobile" maxlength="11"/>
						</div>
					</div>

					<div class="col-xs-3">
						<a id="click-get-code" class="btn btn-warning"></a>
					</div>
					<span id="msg-resend" style="display:none;"><span id="msg-resend-second">30</span>秒后重发</span>
				</ol>
				<ol class="clearfix form-group">
					<label class="sr-only" for="input-code">验证码</label>
					<div class="col-xs-12">
						<div class="row input-group">
							<div class="input-group-addon">
								<i class="glyphicon glyphicon-log-in"></i>
							</div>
							<input class="form-control" autocomplete="off" required placeholder="请输入验证码" type="tel" pattern="[0-9]{6}" id="input-code" maxlength="6"/>
						</div>
					</div>

				</ol>
				<ol class="clearfix form-group">
					<input id="click-verify-code" class="btn btn-warning col-xs-12" type="button" value="登录" disabled="disabled"/>
				</ol>
			</ul>
		</form>
	</div>
</div>

<div class="alert-part col-xs-12">
	<div id="message" class="alert alert-warning"></div>
	<div id="errors" class="alert alert-danger"></div>
</div>


<script>
$(document).ready(function(){

	function getParameterByName(name) {
	    var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
	    return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
	}
	
	function csrfSafeMethod(method) {
	    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}
	
	
	function telRuleCheck(string) {  
	    var pattern = /^1[34578]\d{9}$/;  
	    if (pattern.test(string)) {  
	        return true;  
	    }  
	    console.log('check mobile phone ' + string + ' failed.');  
	    return false;  
	}


    if(!getParameterByName("redirectUrl") || !getParameterByName("encrypt")){
        $("#send-code-form").html("缺少参数.");
    }

    if(!getParameterByName('style')){
        var newStyleLlink = '<link rel="stylesheet" type="text/css" href="/public/css/default.css">';
        $('head').append(newStyleLlink).on((function () {
            $('body').show();
        })());
    }else{
        var newStyleLlink = '<link rel="stylesheet" type="text/css" href="/public/css/'+ getParameterByName('style') +'.css">';
        $('head').append(newStyleLlink).on((function () {
            $('body').show();
        })());
    }

	$.ajaxSetup({
	    crossDomain: false,
	    beforeSend: function(xhr, settings) {
	        if (!csrfSafeMethod(settings.type)) {
	            xhr.setRequestHeader("X-CSRFToken", "0fb87389bf4f1f46628c1054acc0e68d53a43b56ca98e4d9f0b844719bb00e71");
	        }
	    }
	});
	
	
	
	
	$("#click-get-code").click(function(event){
		var mobile = $("#input-mobile").val();
		var redirectUrl = getParameterByName("redirectUrl");
		
		if(!telRuleCheck(mobile)){
			$("#message").show().html("手机号格式错误.");
			return
		}
		
		if(!redirectUrl){
			$("#message").show().html("跳转地址不能为空.");
			return
		}
		
		$.post("/v1/h5/sms/send",{"mobile":mobile,"redirectUrl":redirectUrl},function(result){
			if(result.resp_code === 1000){
				$("#message").show().html("短信发送成功");
				$("#click-get-code").hide();
				$("#msg-resend").show();
				var second = 30;
				var timer = null;
				timer = setInterval(function(){
					second -= 1;
					if(second >0 ){
						$("#msg-resend-second").html(second);
					}else{
						clearInterval(timer);
						$("#click-get-code").show();
						$("#msg-resend").hide();
					}
				},1000);
			}else{
				$("#message").show().html("短信发送失败");
			}
			console.log(result);
		});
	});


    $('#input-code').bind('input propertychange', function(e) {
        if($(this).val()){
            $('#click-verify-code').attr("disabled", false);
        }else{
            $('#click-verify-code').attr("disabled", true);
        }
    });


    $("#click-verify-code").on('click',function(event){
        if($('#input-code').val()){
            var mobile = $("#input-mobile").val();
            var redirectUrl = encodeURI(getParameterByName("redirectUrl"));
            var encrypt = getParameterByName("encrypt");
            var code = $("#input-code").val();

            if(!telRuleCheck(mobile)){
                $("#message").show().html("手机号格式错误.");
                return
            }


            if(!redirectUrl){
                $("#message").show().html("跳转地址不能为空.");
                return
            }

            if(!code){
                $("#message").show().html("验证码不能为空.");
                return
            }

            if(!encrypt){
                $("#message").show().html("加密信息不能为空.");
                return
            }

            var arg = {"mobile":mobile,"redirectUrl":redirectUrl,"code":code,"encrypt":encrypt};
            $.post("/v1/h5/sms/verify",arg,function(result){
                if(result.resp_code === 1000){
                    $("#message").show().html("验证成功");
                    var concat = redirectUrl.indexOf("?")!=-1 ? "&" : "?";
                    $(location).attr('href',redirectUrl+concat+$.param([{"name":"userInfo","value":result.result},{"name":"keyid","value":result.keyid}]));
                }else{
                    $("#message").show().html("验证失败,请重新获取短信验证码.");
                }
                console.log(result);
            });
        }
    });

    if (/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)) {
        $('input[type=tel]').on('focus',function () {
            $('ol:last-child').css({'position':'absolute','bottom':'auto','top':'18rem'});

        });
        $('input[type=tel]').on('blur',function (e) {

			e.stopPropagation();
        });
    }

});

</script>

  
  </body>
</html>

