CAV={FRONT:0,BACK:1,DOUBLE:2,SVGNS:"http://www.w3.org/2000/svg"};CAV.Array=typeof Float32Array==="function"?Float32Array:Array;CAV.Utils={isNumber:function(b){return !isNaN(parseFloat(b))&&isFinite(b);
}};(function(){for(var e=0,d=["ms","moz","webkit","o"],f=0;f<d.length&&!window.requestAnimationFrame;++f){window.requestAnimationFrame=window[d[f]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[d[f]+"CancelAnimationFrame"]||window[d[f]+"CancelRequestAnimationFrame"];
}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(a){var j=(new Date).getTime(),i=Math.max(0,16-(j-e)),h=window.setTimeout(function(){a(j+i);
},i);e=j+i;return h;};}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(b){clearTimeout(b);};}})();Math.PIM2=Math.PI*2;Math.PID2=Math.PI/2;
Math.randomInRange=function(d,c){return d+(c-d)*Math.random();};Math.clamp=function(e,d,f){e=Math.max(e,d);return e=Math.min(e,f);};CAV.Vector3={create:function(f,e,h){var g=new CAV.Array(3);
this.set(g,f,e,h);return g;},clone:function(d){var c=this.create();this.copy(c,d);return c;},set:function(f,e,h,g){f[0]=e||0;f[1]=h||0;f[2]=g||0;return this;
},setX:function(d,c){d[0]=c||0;return this;},setY:function(d,c){d[1]=c||0;return this;},setZ:function(d,c){d[2]=c||0;return this;},copy:function(d,c){d[0]=c[0];
d[1]=c[1];d[2]=c[2];return this;},add:function(d,c){d[0]+=c[0];d[1]+=c[1];d[2]+=c[2];return this;},addVectors:function(e,d,f){e[0]=d[0]+f[0];e[1]=d[1]+f[1];
e[2]=d[2]+f[2];return this;},addScalar:function(d,c){d[0]+=c;d[1]+=c;d[2]+=c;return this;},subtract:function(d,c){d[0]-=c[0];d[1]-=c[1];d[2]-=c[2];return this;
},subtractVectors:function(e,d,f){e[0]=d[0]-f[0];e[1]=d[1]-f[1];e[2]=d[2]-f[2];return this;},subtractScalar:function(d,c){d[0]-=c;d[1]-=c;d[2]-=c;return this;
},multiply:function(d,c){d[0]*=c[0];d[1]*=c[1];d[2]*=c[2];return this;},multiplyVectors:function(e,d,f){e[0]=d[0]*f[0];e[1]=d[1]*f[1];e[2]=d[2]*f[2];return this;
},multiplyScalar:function(d,c){d[0]*=c;d[1]*=c;d[2]*=c;return this;},divide:function(d,c){d[0]/=c[0];d[1]/=c[1];d[2]/=c[2];return this;},divideVectors:function(e,d,f){e[0]=d[0]/f[0];
e[1]=d[1]/f[1];e[2]=d[2]/f[2];return this;},divideScalar:function(d,c){c!==0?(d[0]/=c,d[1]/=c,d[2]/=c):(d[0]=0,d[1]=0,d[2]=0);return this;},cross:function(g,f){var j=g[0],i=g[1],h=g[2];
g[0]=i*f[2]-h*f[1];g[1]=h*f[0]-j*f[2];g[2]=j*f[1]-i*f[0];return this;},crossVectors:function(e,d,f){e[0]=d[1]*f[2]-d[2]*f[1];e[1]=d[2]*f[0]-d[0]*f[2];e[2]=d[0]*f[1]-d[1]*f[0];
return this;},min:function(d,c){d[0]<c&&(d[0]=c);d[1]<c&&(d[1]=c);d[2]<c&&(d[2]=c);return this;},max:function(d,c){d[0]>c&&(d[0]=c);d[1]>c&&(d[1]=c);d[2]>c&&(d[2]=c);
return this;},clamp:function(e,d,f){this.min(e,d);this.max(e,f);return this;},limit:function(f,e,h){var g=this.length(f);e!==null&&g<e?this.setLength(f,e):h!==null&&g>h&&this.setLength(f,h);
return this;},dot:function(d,c){return d[0]*c[0]+d[1]*c[1]+d[2]*c[2];},normalise:function(b){return this.divideScalar(b,this.length(b));},negate:function(b){return this.multiplyScalar(b,-1);
},distanceSquared:function(g,f){var j=g[0]-f[0],i=g[1]-f[1],h=g[2]-f[2];return j*j+i*i+h*h;},distance:function(d,c){return Math.sqrt(this.distanceSquared(d,c));
},lengthSquared:function(b){return b[0]*b[0]+b[1]*b[1]+b[2]*b[2];},length:function(b){return Math.sqrt(this.lengthSquared(b));},setLength:function(e,d){var f=this.length(e);
f!==0&&d!==f&&this.multiplyScalar(e,d/f);return this;}};CAV.Vector4={create:function(f,e,h){var g=new CAV.Array(4);this.set(g,f,e,h);return g;},set:function(g,f,j,i,h){g[0]=f||0;
g[1]=j||0;g[2]=i||0;g[3]=h||0;return this;},setX:function(d,c){d[0]=c||0;return this;},setY:function(d,c){d[1]=c||0;return this;},setZ:function(d,c){d[2]=c||0;
return this;},setW:function(d,c){d[3]=c||0;return this;},add:function(d,c){d[0]+=c[0];d[1]+=c[1];d[2]+=c[2];d[3]+=c[3];return this;},multiplyVectors:function(e,d,f){e[0]=d[0]*f[0];
e[1]=d[1]*f[1];e[2]=d[2]*f[2];e[3]=d[3]*f[3];return this;},multiplyScalar:function(d,c){d[0]*=c;d[1]*=c;d[2]*=c;d[3]*=c;return this;},min:function(d,c){d[0]<c&&(d[0]=c);
d[1]<c&&(d[1]=c);d[2]<c&&(d[2]=c);d[3]<c&&(d[3]=c);return this;},max:function(d,c){d[0]>c&&(d[0]=c);d[1]>c&&(d[1]=c);d[2]>c&&(d[2]=c);d[3]>c&&(d[3]=c);
return this;},clamp:function(e,d,f){this.min(e,d);this.max(e,f);return this;}};CAV.Color=function(d,c){this.rgba=CAV.Vector4.create();this.hex=d||"#000000";
this.opacity=CAV.Utils.isNumber(c)?c:1;this.set(this.hex,this.opacity);};CAV.Color.prototype={set:function(e,d){var e=e.replace("#",""),f=e.length/3;this.rgba[0]=parseInt(e.substring(f*0,f*1),16)/255;
this.rgba[1]=parseInt(e.substring(f*1,f*2),16)/255;this.rgba[2]=parseInt(e.substring(f*2,f*3),16)/255;this.rgba[3]=CAV.Utils.isNumber(d)?d:this.rgba[3];
return this;},hexify:function(b){b=Math.ceil(b*255).toString(16);b.length===1&&(b="0"+b);return b;},format:function(){var e=this.hexify(this.rgba[0]),d=this.hexify(this.rgba[1]),f=this.hexify(this.rgba[2]);
return this.hex="#"+e+d+f;}};CAV.Object=function(){this.position=CAV.Vector3.create();};CAV.Object.prototype={setPosition:function(e,d,f){CAV.Vector3.set(this.position,e,d,f);
return this;}};CAV.Light=function(d,c){CAV.Object.call(this);this.ambient=new CAV.Color(d||"#FFFFFF");this.diffuse=new CAV.Color(c||"#FFFFFF");this.ray=CAV.Vector3.create();
};CAV.Light.prototype=Object.create(CAV.Object.prototype);CAV.Vertex=function(e,d,f){this.position=CAV.Vector3.create(e,d,f);};CAV.Vertex.prototype={setPosition:function(e,d,f){CAV.Vector3.set(this.position,e,d,f);
return this;}};CAV.Triangle=function(e,d,f){this.a=e||new CAV.Vertex;this.b=d||new CAV.Vertex;this.c=f||new CAV.Vertex;this.vertices=[this.a,this.b,this.c];
this.u=CAV.Vector3.create();this.v=CAV.Vector3.create();this.centroid=CAV.Vector3.create();this.normal=CAV.Vector3.create();this.color=new CAV.Color;this.polygon=document.createElementNS(CAV.SVGNS,"polygon");
this.polygon.setAttributeNS(null,"stroke-linejoin","round");this.polygon.setAttributeNS(null,"stroke-miterlimit","1");this.polygon.setAttributeNS(null,"stroke-width","1");
this.computeCentroid();this.computeNormal();};CAV.Triangle.prototype={computeCentroid:function(){this.centroid[0]=this.a.position[0]+this.b.position[0]+this.c.position[0];
this.centroid[1]=this.a.position[1]+this.b.position[1]+this.c.position[1];this.centroid[2]=this.a.position[2]+this.b.position[2]+this.c.position[2];CAV.Vector3.divideScalar(this.centroid,3);
return this;},computeNormal:function(){CAV.Vector3.subtractVectors(this.u,this.b.position,this.a.position);CAV.Vector3.subtractVectors(this.v,this.c.position,this.a.position);
CAV.Vector3.crossVectors(this.normal,this.u,this.v);CAV.Vector3.normalise(this.normal);return this;}};CAV.Geometry=function(){this.vertices=[];this.triangles=[];
this.dirty=false;};CAV.Geometry.prototype={update:function(){if(this.dirty){var d,c;for(d=this.triangles.length-1;d>=0;d--){c=this.triangles[d],c.computeCentroid(),c.computeNormal();
}this.dirty=false;}return this;}};CAV.Plane=function(i,h,n,m){CAV.Geometry.call(this);this.width=i||100;this.height=h||100;this.segments=n||4;this.slices=m||4;
this.segmentWidth=this.width/this.segments;this.sliceHeight=this.height/this.slices;var l,k,j,n=[];l=this.width*-0.5;k=this.height*0.5;for(i=0;i<=this.segments;
i++){n.push([]);for(h=0;h<=this.slices;h++){m=new CAV.Vertex(l+i*this.segmentWidth,k-h*this.sliceHeight),n[i].push(m),this.vertices.push(m);}}for(i=0;i<this.segments;
i++){for(h=0;h<this.slices;h++){m=n[i+0][h+0],l=n[i+0][h+1],k=n[i+1][h+0],j=n[i+1][h+1],t0=new CAV.Triangle(m,l,k),t1=new CAV.Triangle(k,l,j),this.triangles.push(t0,t1);
}}};CAV.Plane.prototype=Object.create(CAV.Geometry.prototype);CAV.Material=function(d,c){this.ambient=new CAV.Color(d||"#444444");this.diffuse=new CAV.Color(c||"#FFFFFF");
this.slave=new CAV.Color;};CAV.Mesh=function(d,c){CAV.Object.call(this);this.geometry=d||new CAV.Geometry;this.material=c||new CAV.Material;this.side=CAV.FRONT;
this.visible=true;};CAV.Mesh.prototype=Object.create(CAV.Object.prototype);CAV.Mesh.prototype.update=function(i,h){var n,m,l,k,j;this.geometry.update();
if(h){for(n=this.geometry.triangles.length-1;n>=0;n--){m=this.geometry.triangles[n];CAV.Vector4.set(m.color.rgba);for(l=i.length-1;l>=0;l--){k=i[l],CAV.Vector3.subtractVectors(k.ray,k.position,m.centroid),CAV.Vector3.normalise(k.ray),j=CAV.Vector3.dot(m.normal,k.ray),this.side===CAV.FRONT?j=Math.max(j,0):this.side===CAV.BACK?j=Math.abs(Math.min(j,0)):this.side===CAV.DOUBLE&&(j=Math.max(Math.abs(j),0)),CAV.Vector4.multiplyVectors(this.material.slave.rgba,this.material.ambient.rgba,k.ambient.rgba),CAV.Vector4.add(m.color.rgba,this.material.slave.rgba),CAV.Vector4.multiplyVectors(this.material.slave.rgba,this.material.diffuse.rgba,k.diffuse.rgba),CAV.Vector4.multiplyScalar(this.material.slave.rgba,j),CAV.Vector4.add(m.color.rgba,this.material.slave.rgba);
}CAV.Vector4.clamp(m.color.rgba,0,1);}}return this;};CAV.Scene=function(){this.meshes=[];this.lights=[];};CAV.Scene.prototype={add:function(b){b instanceof CAV.Mesh&&!~this.meshes.indexOf(b)?this.meshes.push(b):b instanceof CAV.Light&&!~this.lights.indexOf(b)&&this.lights.push(b);
return this;},remove:function(b){b instanceof CAV.Mesh&&~this.meshes.indexOf(b)?this.meshes.splice(this.meshes.indexOf(b),1):b instanceof CAV.Light&&~this.lights.indexOf(b)&&this.lights.splice(this.lights.indexOf(b),1);
return this;}};CAV.Renderer=function(){this.halfHeight=this.halfWidth=this.height=this.width=0;};CAV.Renderer.prototype={setSize:function(d,c){if(!(this.width===d&&this.height===c)){return this.width=d,this.height=c,this.halfWidth=this.width*0.5,this.halfHeight=this.height*0.5,this;
}},clear:function(){return this;},render:function(){return this;}};CAV.CanvasRenderer=function(){CAV.Renderer.call(this);this.element=document.createElement("canvas");
this.element.style.display="block";this.context=this.element.getContext("2d");this.setSize(this.element.width,this.element.height);};CAV.CanvasRenderer.prototype=Object.create(CAV.Renderer.prototype);
CAV.CanvasRenderer.prototype.setSize=function(d,c){CAV.Renderer.prototype.setSize.call(this,d,c);this.element.width=d;this.element.height=c;this.context.setTransform(1,0,0,-1,this.halfWidth,this.halfHeight);
return this;};CAV.CanvasRenderer.prototype.clear=function(){CAV.Renderer.prototype.clear.call(this);this.context.clearRect(-this.halfWidth,-this.halfHeight,this.width,this.height);
return this;};CAV.CanvasRenderer.prototype.render=function(h){CAV.Renderer.prototype.render.call(this,h);var g,l,k,j,i;this.clear();this.context.lineJoin="round";
this.context.lineWidth=1;for(g=h.meshes.length-1;g>=0;g--){if(l=h.meshes[g],l.visible){l.update(h.lights,true);for(k=l.geometry.triangles.length-1;k>=0;
k--){j=l.geometry.triangles[k],i=j.color.format(),this.context.beginPath(),this.context.moveTo(j.a.position[0],j.a.position[1]),this.context.lineTo(j.b.position[0],j.b.position[1]),this.context.lineTo(j.c.position[0],j.c.position[1]),this.context.closePath(),this.context.strokeStyle=i,this.context.fillStyle=i,this.context.stroke(),this.context.fill();
}}}return this;};