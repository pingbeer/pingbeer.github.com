<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "https://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta name="format-detection" content="telephone=no">
	<meta http-equiv="Cache-Control" content="max-age=1" />
	<title>商品详情</title>
	<link rel="stylesheet" href="./css/basic.css">
	<link rel="stylesheet" href="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_css/smoothness/jquery-ui-1.10.1.custom.css">
	<link rel="stylesheet" href="./css/customDialog.css?v=1">
	
	<script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/jquery.min.js"></script>
	<script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/jquery-ui-1.10.1.custom.min.js"></script>

	<script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/salama/preventClickDoubleFired.js"></script>
    <script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/salama/easyJsDomUtil.js"></script>
    <script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/salama/salamaWebClientService.js"></script>
    <script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/activity/common_js/lib/salama/salamaClientService.js"></script>
    <script src="https://magicactivity.oss-cn-hangzhou.aliyuncs.com/scrm/scrm_collector.js?v=10"></script>

    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js?v=1"></script>
	<script src="./myjs/lib/myCommon.js?v=1"></script>
    <script src="./myjs/lib/customDialog.js"></script>
	<script src="./myjs/lib/commonShare.js?v=1"></script>
    <script src="./myjs/lib/shopCommon.js?v=1"></script>
    <script src="./myjs/lib/myLocation.js?v=1"></script>

	<!-- <script src="./myjs/catalog_pro_detail.js?v=22"></script> -->
	<script>
	var catalogProDetailPage = new CatalogProDetailPage();

if(window.__skipInitPage == undefined || !window.__skipInitPage) {
    $(document).ready(function() {
        setHtmlFontSize();
        commonShare.initWxSetting(catalogProDetailPage.initPage,null,true,true);
    });
}

function CatalogProDetailPage() {

    var _this = this;

    this.initPage = function() {
        _this.activityItemId = $my.getUrlParam("link_id");
        _this.pageTitle = $my.getUrlParam("page_title");
//        _this.cityCode = $my.getUrlParam("cityCode");

        _this.afterVerify = $my.getUrlParam("after_verify");
        _this.activity = $my.getUrlParam("activity");

        initFormInfo();
    };

    function initFormInfo(){
        $my.showLoading();

        if(!$my.string.isEmpty(_this.pageTitle)) {
            $("title").text(decodeURIComponent(_this.pageTitle));
        }

        // 绑定事件
        $('#backPage').unbind("click").bind('click',function(){ //左上角返回
            gotoAppIndex();
        });

        $myLocation.getCityCodeFromCookie(function(cityCode) {
            _this.cityCode = cityCode;
        });


        if(_this.activity == "1" && _this.afterVerify != "1") {
            var locationUrl = window.document.location.href;
            var locationUrlParams = locationUrl.substr(locationUrl.indexOf("?") + 1);
            var forwardPageUrl = "catalog_pro_detail.html?" + locationUrlParams + "&after_verify=1";
            $my.verifyUserInfo(encodeURIComponent(forwardPageUrl));
            return;
        }

        initMenu();
        $my.async.series([
            initItemInfo,
            initFavorite,
            initBuy
        ], function(totalCount, doneCount) {
            if(totalCount == doneCount) {
                $('[id="page"]').removeClass('vis_h');
                $my.hideLoading();
            }
        });
    }

    // --------------- 底部菜单 -----------------------
    function initMenu() {
        $(".navi_menu_index").on("click",function(){
            window.location = "./index.html";
        });

        $(".navi_menu_center").on("click",function(){
            $my.verifyUserInfo("user_center.html");
        });
    }
    // --------------- 底部菜单 End -----------------

    // ------------- 收藏 -----------------
    function initFavorite(callback) {
        searchItemCollectedStatus(callback);

        $(".navi_menu_fav").on("click", function() {
            if($(".navi_menu_fav").hasClass("on")){
                cancelCollect();
            } else {
                collectItem();
            }
        });
    }

    function searchItemCollectedStatus(callback){
        $my.ajax({
            url: $my.getCloudDataServiceUrl(),
            data: {
                serviceType: "com.ebuy.shop.web.service.UserFavoriteService",
                serviceMethod: "searchUserFavoriteDetail",
                activity_item_id: _this.activityItemId
            },
            success: function (response) {
                if (response && response.length > 0) {
                    $(".navi_menu_fav").addClass("on");
                } else {
                    $(".navi_menu_fav").removeClass("on");
                }

                if (callback) {
                    callback();
                }
            },
            error: function (response) {
                if (callback) {
                    callback();
                }
            }
        });

        if(callback) {
            callback();
        }
    }

    function collectItem() {
        if (_this.activityItemId == undefined || _this.activityItemId.length == 0) {
            showDialog.showInfoDialog({msgInfo: "<span class='fwb'>收藏失败</span><br/>请稍后再试"});
            return false;
        }

        $my.ajax({
            url: $my.getCloudDataServiceUrl(),
            data: {
                serviceType: "com.ebuy.shop.web.service.UserFavoriteService",
                serviceMethod: "addUserFavorite",
                activity_item_id: _this.activityItemId
            },
            success: function(response) {
                if (response.length > 0 && response == 0) {
                    $(".navi_menu_fav").addClass("on");
                    showDialog.showInfoDialog({msgInfo: "收藏成功"});
                } else {
                    showDialog.showInfoDialog({msgInfo: "<span class='fwb'>收藏失败</span><br/>请稍后再试"});
                }
            }
        });
    }

    function cancelCollect(){
        $my.ajax({
            url: $my.getCloudDataServiceUrl(),
            data: {
                serviceType: "com.ebuy.shop.web.service.UserFavoriteService",
                serviceMethod: "cancelUserFavorite",
                activity_item_id:_this.activityItemId
            },
            success: function(response) {
                if (response && response == 0) {
                    $(".navi_menu_fav").removeClass("on");
                    showDialog.showInfoDialog({msgInfo: "取消成功"});
                } else {
                    showDialog.showInfoDialog({msgInfo: "取消失败,请稍后再试"});
                }
            },
            error: function(response) {
                showDialog.showInfoDialog({msgInfo: "取消失败,请稍后再试"});
            }
        });
    }
    // --------------- 收藏 End --------------------

    // --------------- 查询证件号 -----------------------
    function initUserCertNoVerification(callback) {
        $my.ajax({
            url: $my.getCloudDataServiceUrl(),
            data: {
                serviceType: "com.ebuy.shop.web.service.UserLoginService",
                serviceMethod: "getUserCertNoByVerifyFinished"
            },
            success: function(response) {
                _this.certNo = response;

                if(callback) {
                    callback();
                }
            },
            error: function() {
                $shop.showCommonErrorMsg();
            }
        });
    }
    // --------------- 查询证件号 End -------------------

    // --------------- 查询商品详情 -------------------------
    function initItemInfo(callback) {
        searchItemInfo(callback);
    }

    function searchItemInfo(callback) {
        $my.ajax({
            url: $my.getCloudDataServiceUrl(),
            data: {
                serviceType: "com.ebuy.shop.web.service.ItemService",
                serviceMethod: "searchActivityItemDetail",
                activityItemId: _this.activityItemId
            },
            success: function (response) {

                if (response && response.length > 0) {
                    var result = easyJsDomUtil.parseXML(response);
                    var resultData = $(result).find("resultData");

                    var itemName = $(resultData).find('name').text();
                    var factPrice = $(resultData).find('fact_price').text();
                    var description = $(resultData).find('description').text();
                    var stock = $(resultData).find('stock').text();
                    var shipping_type = $(resultData).find('shipping_type').text();
                    var json = eval("(" + description + ")");
                    var couponId = json.ecoupon_id;
                    if (couponId != "" || couponId != null) {
                        searchCouponInfo(couponId);
                    }
                    $("#itemName").html(itemName);
                    $("#itemUrl").attr("src", json.detail_pic_url);
                    var itemDetail = json.item_info.replace(/\n/g, "</br>");
                    $("#itemDetail").html(itemDetail);
                    var create_coupon_flag = json.create_coupon_flag;

                    if(create_coupon_flag != 1){
                        $('#use_rule').hide();
                        $('#transfer_desc').hide();
                    }

//                	var transfer_desc = json.transfer_desc.replace(/\n/g, "</br>");
//                	$("#transfer_desc").html(transfer_desc);

                    if(json.price_type == 1) {
                        $("#itemPrice").html(factPrice + "元");
                    }
                    if(json.price_type == 2) {
                        $("#itemPrice").html(factPrice + "积分");
                    }
                    if(json.price_type == 3) {
                        var factPriceArr = factPrice.split("+");
                        $("#itemPrice").html(factPriceArr[0] + "元+" + factPriceArr[1] + "积分");
                    }
                    if(json.price_type == 4) {
                        $("#itemPrice").html(factPrice + "元");
                    }

                    if(Number(json.pay_point_money_price) + Number(json.pay_money_price) == 0) {
                        $("#buy_btn").text("立即领取");
                    }
                    if (shipping_type == "1" || shipping_type == "2") {
                        $('[id="store"]').hide();
                    }

                    _this.activityNo = json.activity_no;

                    var item_type = json.item_type;
                    var item_catalog = '未分类商品';
                    if(item_type == '1'){ //商城商品
                        item_catalog = '商城商品';
                    }else if(item_type == '2'){ //活动商品
                        item_catalog = '活动商品';
                    }else if(item_type == '3'){ //第三方商品
                        item_catalog = '第三方商品';
                    }else if(item_type == '4'){ //特权商品
                        item_catalog = '特权商品';
                    }else if(item_type == '5'){ //商城免费券
                        item_catalog = '商城免费券';
                    }else if(item_type == '6'){ //天天特价活动商品
                        item_catalog = '天天特价活动商品';
                    }else if(item_type == '7'){ //日日优惠活动商品
                        item_catalog = '日日优惠活动商品';
                    }else if(item_type == '8'){ //用户专享活动商品
                        item_catalog = '用户专享活动商品';
                    }else if(item_type == '9'){ //抽奖活动商品
                        item_catalog = '抽奖活动商品';
                    }else if(item_type == '10'){//小浦闪付
                        item_catalog = '小浦闪付商品';
                    }

                    $("#buy_btn").show();
                    $("#sale_out_btn").hide();

                    // baidu-1009  XZB

                    _hmt.push(['_trackEvent', itemName, 'click','详情'+item_catalog]);

                    if(callback) {
                        callback();
                    }

                } else {
                    showDialog.showInfoDialog({msgInfo: "操作失败，读取商品信息错误"});
                }
            },
            error: function (response) {
                if (callback) {
                    callback();
                }
            }
        });
    }

    function searchCouponInfo(couponId) {
        var url = 'https://o2omaster.oss-cn-hangzhou.aliyuncs.com/couponInfo/' + couponId + '/couponInfo.json';
        $.ajax({
            url : url,
            dataType: "jsonp",
            jsonpCallback: "ossCallBack",
            timeout: 3000,
            success: function (data) {
                //商品详情画面商品细则优化 1-22
                $("#use_rule").show();
                $("#transfer_desc").show();

                var json = eval("(" + data.display_info + ")");
                $("#transfer_desc").html(json.data.useInfo.replace(/\n/g, "</br>"));

                if (data.valid_type == 1) {
                    var date = new Date(parseInt(data.expire_time));
                    var year=date.getFullYear();
                    var month=date.getMonth()+1;
                    var getdate=date.getDate();
                    $("#effect_time").text("即日起至" + year + "." + month + "." + getdate + "止");
                } else if (data.valid_type == 2) {
                    $("#effect_time").text("购买之日" + data.delay_day + "日后" + data.valid_day + "天内有效");
                } else if (data.valid_type == 3){
                    var date = new Date(parseInt(data.expire_time));
                    var year=date.getFullYear();
                    var month=date.getMonth()+1;
                    var getdate=date.getDate();
                    if (data.delay_day == "0" || data.delay_day == 0) {
                        $("#effect_time").text("当日生效,至" + year + "-" + month + "-" + getdate + "止");
                    } else {
                        $("#effect_time").text("购买之日" + data.delay_day + "日后生效,至"  + year + "-" + month + "-" + getdate + "止");
                    }
                }

                $('.pro_d_shop').on('click',function(){
                    window.location = $my.getWebApp() + "/shop_list/coupon_shop_list.html?couponId=" + couponId;
                });
            },
            error: function (jqXHR, textStatus, errorThrown ){
                console.log("没有码券适用规则");
            }
        });
    }
    // --------------- 查询商品详情 End -------------------------

    // --------------- 立即购买 ------------------------
    function initBuy(callback) {
        $("#buy_btn").unbind("click").bind("click", function() {
            $my.showLoading();

            // if(!$my.string.isEmpty(_this.activityNo)) {
            //     checkActivityAuth(createTmpUserOrder);
            // } else {
            //     createTmpUserOrder();
            // }
            createTmpUserOrder();
        });

        if(callback) {
            callback();
        }
    }

    //issues #30 start
    function createTmpUserOrder() {
        var resultData="201801231101320469832509";// 临时的
        $my.ajax({
            url: $my.getCloudDataServiceUrl(),
            data: {
                serviceType: "com.ebuy.shop.web.service.UserOrderCreateService",
                serviceMethod: "createCommonUserOrderToRedis",
                activityItemId: _this.activityItemId,
                cityCode : _this.cityCode
            },
            success: function(response) {
                $my.hideLoading();
        
                if(response && response.length > 0) {

                    var result = easyJsDomUtil.parseXML(response);
                    // var resultData = $(result).find('resultData').text();
                    // //Issue #37
                    // //新增状态码验证
                    // if(!$rcc.checkPageResult(result,_this.activityItemId)){
                    //     return;
                    // }
                     resultData = $(result).find('resultData').text();
                    window.location = $my.getWebApp() + "/catalog_pro_buy.html?app_order_no=" + resultData + "&activity_item_id=" + _this.activityItemId + "&order_type=0";

                }
                window.location = $my.getWebApp() + "/catalog_pro_buy.html?app_order_no=" + resultData + "&activity_item_id=" + _this.activityItemId + "&order_type=0";
            },
            error: function() {
                window.location = $my.getWebApp() + "/catalog_pro_buy.html?app_order_no=" + resultData + "&activity_item_id=" + _this.activityItemId + "&order_type=0";
                // $my.hideLoading();
                // $shop.showCommonErrorMsg();
            }
        });
    }
    //issues #30 end
    // --------------- 立即购买事件 End ---------------------

    // ------------ 验证抢购权限 -----------------------
    function checkActivityAuth(callback) {
        $my.showLoading();
        $my.ajax({
            url: $my.getCloudDataServiceUrl(),
            data: {
                serviceType: "com.ebuy.shop.web.service.ActivityService",
                serviceMethod: "searchUserAuth",
                activityItemId: _this.activityItemId
            },
            success: function(response) {
                $my.hideLoading();
                if(response && response.length > 0) {
                    var result = easyJsDomUtil.parseXML(response);
                    var resultData = $(result).find('resultData');
                    var resultCode = $(result).find('resultCode').text();
                    var errorMsg = $(result).find('errorMsg').text();

                    if(resultCode != "0") {
                        showDialog.showInfoDialog({msgInfo: $my.string.isEmpty(errorMsg) ? "操作失败" : errorMsg});
                        return;
                    }

                    if($(resultData).text() != "1") {
                        showDialog.showInfoDialog({msgInfo: "您没有权限抢购该商品"});
                        return;
                    } else {
                        if(callback) {
                            callback();
                        }
                    }
                }
            }
        });
    }
    // ------------ 验证抢购权限 End -----------------------
}

//Issue #37
//-------------添加pageResult验证----------------------
(function(window, undefined) {
    var returnCodeCheck = new ReturnCodeCheck();

    function ReturnCodeCheck() {
        var _this = this;

        this.checkPageResult = function(result,activityItemId){
            var code = $(result).find('resultCode').text();
            var errorMsg = $(result).find('errorMsg').text();
            var resultData = $(result).find('resultData').text();
            if(code == '0'){
                return true;
            }
            // 增加各种返回码的处理
            else if(code == '11715'){
                showDialog.showInfoDialog({title: "提示信息", msgInfo: "每人仅限享一次优惠购买权益"});
            }
            else if(code == '11716'){
                showDialog.showInfoDialog({title: "提示信息", msgInfo: "抱歉，本券仅限小浦闪用新客户专享，返回首页继续逛逛呗，一大波优惠等着您！"});
            }
            else if(code == "-10") {
                window.location.href = "./common_busy.html";
            }
            else if(code == "-11") {
                //用户需要验证
                var forwardPageUrl = "catalog_pro_buy.html?app_order_no=" + resultData + "&activity_item_id=" + activityItemId + "&order_type=0";
                $my.verifyUserInfo(encodeURIComponent(forwardPageUrl));
            }
            else if(code == '15'){
                var forwardPageUrl = "/activity_pro_list_data.html?activity_type=7";
                forwardPageUrl += "&page_title="+encodeURIComponent("日日优惠")+"&timestamp=" + (new Date()).getTime();
                showDialog.showInfoDialog({title: "提示信息", msgInfo: errorMsg,btnOk:function(){
                    window.location = $my.getWebApp() + forwardPageUrl;
                }});
            }else if(code >0){
                showDialog.showInfoDialog({title: "提示信息", msgInfo: errorMsg});
            }else{
                //如果上述通用判断无法解决，就回到代码里解决
                return true;
            }
            return false;
        }
    }

    window.$rcc = returnCodeCheck;
})(window);
//-------------添加pageResult验证end----------------------
	</script>
<style>
.pro_d_2{padding:0.5rem;position:relative;min-height:2rem;}
.pro_d_name{font-size:0.85rem;color:#a98f5c;line-height:1.2rem;margin-bottom:0.1rem;/*margin-right:6.2rem;*/}
.pro_d_time{font-size:0.6rem;color:#999;line-height:0.8rem;}
.pro_d_price{/*position:absolute;right:0.5rem;top:0.55rem;*/color:#CC0001;font-size:0.85rem;font-weight:bold;}
.pro_d_3{border-top:0.25rem solid #f0f0f0;border-bottom:0.25rem solid #f0f0f0;}
.pro_d_shop{border-bottom:1px solid #eee;padding:0.3rem 0.5rem;color:#a98f5c;font-size:0.75rem;line-height:1.2rem;position:relative;padding-left:1.5rem;background-image:url('https://spdticket-prod.oss-cn-hangzhou.aliyuncs.com/imgs/icon/icon_address.png');background-size:0.85rem auto;background-repeat:no-repeat;background-position:0.5rem center;}
.pro_d_shop:after{content:'';width:1rem;height:1.75rem;background-image:url('https://spdticket-prod.oss-cn-hangzhou.aliyuncs.com/imgs/icon/icon_arrow_right.jpg');background-repeat:no-repeat;background-position:center center;background-size:0.5rem auto;display:block;position:absolute;right:0;top:0;}
.pro_d_shop_count{font-size:0.6rem;line-height:1rem;padding:0.3rem 0.5rem;}
.pro_d_4{padding:0.5rem;font-size:0.6rem;line-height:0.9rem;color:#888;}
.pro_d_4 h3{font-size:0.8rem;line-height:1.1rem;margin-bottom:0.2rem;}

.sale_out{width:8.8rem;height:2.4rem;float: left;background:#C1B6B7;text-align: center;font-size:0.8rem;color:#fff;line-height:2.4rem;}
</style>
</head>
<body>
	<div class="page vis_h" id="page">

		<!-- 商品详细start -->
		<div class="m_catalog_pro_detail mb24">
			<div class="pro_d_1">
				<img src="" alt="" id="itemUrl">
			</div>
			<div class="pro_d_2">
				<div class="pro_d_name" id="itemName"></div>
				<div class="pro_d_time"  style="display:none">有效期:<span id="effect_time"></span></div>
				<div class="pro_d_price"><span id="itemPrice"></span></div>
			</div>
			<div class="pro_d_3" id="shopDiv">
				<div class="pro_d_shop" id="store">
					适用门店
				</div>
				<div class="pro_d_shop_count clearfix" style="display:none">
					<div class="fl">全部门店信息</div>
					<!--  <div class="fr">共<span>20</span>家</div> -->
				</div>
			</div>
			<!-- 2018-1-22 -->
			<div class="pro_d_4">
				<h3 id="item">商品细则</h3>
				<div class="pro_d_desc" id="itemDetail">
				</div>
				<h3 id="use_rule" style="display: none;">券细则</h3>
				<div class="pro_d_desc" id="transfer_desc" style="display: none;">
				</div>
			</div>
			<!-- <div class="pro_d_4">
				<h3>商品详情</h3>
				<div class="pro_d_desc" id="itemDetail">
				</div>
			</div> -->
		</div>
		<!-- 商品详细end -->

		<!-- 菜单start -->
		<div class="m_navi_menu">
			<div class="clearfix">
				<div class="navi_menu_index">
					<span>首页</span>
				</div>
				<div class="navi_menu_center">
					<span>我的</span>
				</div>
				<div class="navi_menu_fav"> <!--addClass(on)-->
					<span>收藏</span>
				</div>
				<div class="navi_menu_buybtn" id="buy_btn">
					立即购买
				</div>
				<div class="sale_out" id="sale_out_btn">
					已售罄
				</div>
			</div>
		</div>
		<!-- 菜单end -->
	</div>
	
	<div class="overLayer" id="overLayer" style="display:none"></div>
</body>
</html>