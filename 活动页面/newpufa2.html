<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>1积分爆款抢</title>
    <link rel="stylesheet" type="text/css" href="css/common.css?v=20171113" />
    <link rel="stylesheet" type="text/css" href="css/style.css?v=20171123" />
    <link rel="stylesheet" href="css/alert.css?v=20171113" />
</head>

<body>
<div id="content">
    <div class="prodectDeatils" id="prodectDeatils">
        <div class="product-tip">1积分爆款抢</div>
        <div id="productBuy">
        </div>
    </div>
    <div class="rightNowROb"><img src="img/rob.png" onclick="goPay()" /></div>
    <!--<div class="extraTip" onclick="Tipshow()">特别提示</div>-->
</div>
<div class="loading">
    <img src="img/loading-2.gif" alt="" />
</div>
<script type="text/javascript" src="js/jquery-1.12.4.min.js?v=20171113" ></script>
<script type="text/javascript" src="js/alertPopShow.js?v=20171113"></script>
<script type="text/javascript" src="js/foot.js?v=20171113"></script>
<script type="text/javascript" src="js/weixinShare.js?v=2017013"></script>
<script type="text/javascript" src="js/common.js?v=20171113"></script>
<script type="text/javascript">
    var params = JSON.parse(window.localStorage.getItem("params"));
    var rebackOrderUrl = sessionStorage.getItem("rebackOrderUrl");
    if (params != null) {
        var userId = params.custId;
        var actCode = params.actCode;
    }
    var payNum = 1;
    var sceneId = getQueryStr("scenId");
    var arr = sceneId.split(",");
    var goodsId = '';
    if (arr != null && arr.length != 0) {
        sceneId = arr[0];
        goodsId = arr[1];
    }
    var respCode;
    var respMsg;
    var isTrue;
    var countdownNum;
    $('#appShare').hide();
    //			var encodeUrl = Host + activitycore+'%252factivity%252fwx%252f' + actCode + '%252ehtm%253ffilename=index';
    //			var linkUrl =  host +xpmcactive+"/act/tohomepageshare/" + encodeUrl;

    $(function() {
        document.addEventListener('WeixinJSBridgeReady',
            function onBridgeReady() {
                WeixinJSBridge.call('hideToolbar'); //隐藏微信界面下方导航栏
                WeixinJSBridge.call('hideOptionMenu'); //隐藏微信界面右上方分享按钮
            }
        );
    })
    //app分享
    function wechatFirend() { //分享给朋友
        window.jsspdb.shareToWXSceneSession(linkUrl, shareTitle, shareContent, "1");
    }

    function weichatGroup() { //分享给朋友圈
        window.jsspdb.shareToWXSceneTimeline(linkUrl, shareTitle, shareContent, "1");
    }
    var obj = {};
    obj.sceneId = sceneId;
    obj.userId = userId;
    obj.actCode = actCode;
    obj.goodsId = goodsId;
    //页面初始化
    $(function() {
        toinfo();
      //  whilte();
        getTimer();
    })
    //页面倒计时
    function getTimer(){
        $.ajax({
            type:"post",
            url:host + activitycore +"/weekrob/getcountdown/"+actCode + "/" + sceneId + ".json?custid=" + userId,
            async:true,
            contentType: "application/json;charset=utf-8",
            success:function(resp){
                if(resp.code == 200){
                    countdownNum = parseInt(resp.data);
                    if(countdownNum == -1){
                        console.log("活动已结束,期待您的下次参与！");
                    }else if(countdownNum == 0){
                        console.log("活动已开始，爆抢进行中！");
                    }else{
                        console.log("活动未1开始，敬请期待！")
                        timer(countdownNum);
                    }
                }
            }

        });
    }
    //倒计时
    function timer(time) {
        var timer = setInterval(function() {
            time = time - 1;
            var getHour = parseInt(time/3600);
            var getMinutes = parseInt((time-getHour*3600)/60);
            var getSeconds = parseInt((time-getHour*3600-getMinutes*60));
            console.log("距离开始时间还有"+getHour+"小时"+getMinutes+"分"+getSeconds+"秒")
            window.sessionStorage.setItem("timed", time); //设置localstorage;
            if (time == -1) {
                $('.product-tip').html("活动已开始，爆抢进行中！");
                clearInterval(timer);
             //   whilte();
            }
        }, 1000);
    }


    //白名单校验
    function whilte() {
        $.ajax({
            type: "post",
            url: host + activitycore + "/activity/order/check/whilte/list/" + actCode + "/" + sceneId + "/" + userId + ".json?custid=" + userId,
            async: true,
            contentType: "application/json;charset=utf-8",
            success: function(resp) {
                respCode = resp.code;
                if(respCode == 103){
                    respMsg = resp.msg;
                    $('.product-tip').html("活动已结束,期待您的下次参与！");
                }else if(respCode == 102){
                    respMsg = resp.msg;
                    $('.product-tip').html("活动未3开始，敬请期待！");
                }else{
                    $('.product-tip').html("活动已开始，爆抢进行中！");
                    if(respCode == 200){
                        respMsg ="";
//								toinfo();
                    }else if(respCode == 106){
                        respMsg = '网络不给力，请检查您的网络状态，稍后再试';
                    }else if(respCode == 107){
                        respMsg = '本场活动，您的抽奖次数已用完，感谢参与';
                    }else if(respCode == 108){
                        respMsg = '已抢到爆品，请到我的订单中进行支付';
                    }else if(respCode == 405){
                        respMsg = resp.msg;
                    }else if(respCode == 414){
                        respMsg ="";
                        isPastDue();
                    }else {
                        respMsg = resp.msg;
                    }
                }
                if(respMsg !=""){
                    popTipShow.alert('提示', respMsg, ['确 定'],
                        function(e) {
                            this.hide();
                        })
                }
            },
            error: function() {
                webToast("网络不给力，请稍后再试", "middle", 2000);
            }
        });
    };
    //去支付
    function goPay() {
        respCode=200;
        if (respCode == 200) {
            var imgNode = host + activitycore + "/vcode/getVCode/" + actCode + "/" + sceneId + "/" + userId + ".json?t=" + Math.random() + "&custid=" + userId;
            console.log(imgNode);
            var imgHml = '<div class="vCode">' + '<p class="vCode-img">' + '<img id="vimg" onclick="changeCode()"  src="' + imgNode + '"/>' + '</p>' + '<p class="vCode-input">' + '<input id="vinput" type="text" placeholder="请输入验证码" maxlength="5"/>' + '</p>' +'<p class="text-center">请输入对应<span style="color:red">红色</span>字体的字</p>'+'<p class="vCode-erro text-center">验证码错误</p>' + '</div>';
            popTipShow.confirm('提o 示', imgHml, ['确定', '取消'],
                function(e) {
                    //callback 处理按钮事件
                    var button = $(e.target).attr('class');
                    if (button == 'ok') {
                        var vcode = $('#vinput').val();
                        //	this.hide();
                        var fundd=function(){
                            $.ajax({
                                type: "post",
                                url: host + activitycore + "/activity/order/grap.json?" + userId,
                                data: JSON.stringify(obj),
                                contentType: "application/json;charset=utf-8",
                                beforeSend: function(){
                                    $(".loading").show();
                                },
                                success: function(resp) {
                                    $(".loading").hide();
                                    if(resp.code){
                                        if(resp.code == 405){
                                            popTipShow.alert('提i示', resp.msg, ['确 定'],
                                                function(e) {
                                                    this.hide();
                                                })
                                        }
                                    }
                                    if (resp.result.indexOf("0000") != -1) { //如果是0000
                                        var orderId = resp.obj.ORDERID;
                                        var pay_status = resp.obj.PAY_STATUS;
                                        var goodsName = resp.obj.name;
                                        //															var goodsHtml = "恭喜您抽中了" + goodsName + ",请在15分钟内支付1积分";
                                        var goodsHtml = "恭喜您已锁定本场奖品,请在15分钟内支付1积分";
                                        if (pay_status == 'yes') { //如果是yes
                                            popTipShow.alert('提y示', goodsHtml, ['确 定'],
                                                function(e) {
                                                    var button = $(e.target).attr('class');
                                                    if (button == 'ok') {
                                                        window.location.href = "paysure.html?payNum=" + payNum + "&sceneId=" + sceneId + "&goodsId=" + goodsId + "&orderId=" + orderId;
                                                    }
                                                })
                                        } else { //如果是no
                                            popTipShow.alert('提t示', goodsHtml, ['确 定'],
                                                function(e) {
                                                    var button = $(e.target).attr('class');
                                                    if (button == 'ok') {
                                                        window.location.href = rebackOrderUrl;
                                                    }
                                                })
                                        }
                                    } else {
                                        var resultTip = resp.result.split(",")[1];
                                        popTipShow.alert('提r示', resultTip, ['确 定'],
                                            function(e) {
                                                var button = $(e.target).attr('class');
                                                if (button == 'ok') {
                                                    window.location.href = rebackOrderUrl;
                                                }
                                            })
                                    }
                                },
                                error: function() {
                                    $(".loading").hide();
                                    webToast("网络不给力，请稍后再试", "middle", 2000);
                                }
                            });
                        }
                        fundd();
                        $.ajax({
                            type: "get",
                            url: host + activitycore + "/vcode/chkVCode/" + actCode + "/" + sceneId + "/" + userId + "/" + vcode + ".json?custid=" + userId,
                            async: true,
                            success: function(resp) {
                                
                                if (resp.code == 200) {
                                    if (resp.data == '1') {
                                        //验证码判断
                                        fundd();
                                    } else {
                                        $('.vCode-erro').show();
                                        changeCode();
                                        return;
                                    }
                                } else if (respCode == 414) {
                                //    isPastDue();
                                } else if (respCode == 108) {
                                    popTipShow.alert('提w示', '已抢到爆品，请到我的订单中进行支付', ['确 定'],
                                        function(e) {
                                            this.hide();
                                        })
                                }else if (respCode == 405) {
                                    popTipShow.alert('提q示', resp.msg, ['确 定'],
                                        function(e) {
                                            this.hide();
                                        })
                                } else {
                                    webToast("网络不给力，请稍后再试", "middle", 2000);
                                }
                            }
                        });
                    }
                    if (button == 'cancel') { //确定
                        this.hide();
                    }
                })
        } else if (respCode == 414) {
            isPastDue();
        } else if (respCode == 102) {
            var timed = parseInt(window.sessionStorage.getItem("timed"));
            if(timed>0){
                popTipShow.alert('提1示', "活动未2开始，敬请期待！", ['确 定'],
                    function(e) {
                        this.hide();
                    })
            }
        } else if (respCode == 106) {
            popTipShow.alert('提2示', '网络不给力，请检查您的网络状态，稍后再试', ['确 定'],
                function(e) {
                    this.hide();
                })
        } else {
            popTipShow.alert('提3示',respMsg, ['确 定'],
                function(e) {
                    this.hide();
                })
        }
    }
    var luckRule = '<div class="luckRule">' +
        '<p>特别提示</p>' +
        '<p>本活动所赠实物礼品将默认递送至您在我行信用卡中心预留的卡片寄送地址。若您在本次抢兑成功后的48小时内通过浦发信用卡各自助渠道或拨打客服热线修改您预留的卡片寄送地址，本活动礼品将寄往您的新的卡片寄送地址。 </p>' +
        '<p>若您在抢兑成功后超过48小时再进行卡片寄送地址的修改， 本活动礼品仍将寄送到您原预留的卡片寄送地址。</p>' +
        '</div>';

    function Tipshow() {
        popTipShow.alert("", luckRule, ['确 定'],
            function(e) {
                this.hide();
            }) //弹出框结束
    }
    //	页面初始化
    function toinfo() {
        $("#content").hide();
        $.ajax({
            type: "post",
            url: host + activitycore + "/weekrob/querygoods/" + actCode + "/" + sceneId + "/" + userId + "/" + goodsId + ".json?custid=" + userId,
            data: JSON.stringify({}),
            async: true,
            contentType: "application/json;charset=utf-8",
            beforeSend: function(){
                $(".loading").show();
            },
            success: function(resp) {
                $(".loading").hide();
                if (resp.code == 200) {
                    $("#content").show();
                    var orderList = resp.data.goodsList;
                    appendOrderDetail(orderList[0]);
                } else if (resp.code == 414) {
                    $("#content").show();
                    isPastDue();
                } else if (resp.code == 405) {
                    $("#content").hide();
                    $("#appShare").hide();
                    popTipShow.alert('提 示', resp.msg, ['确 定'],
                        function(e) {
                            this.hide();
                        }
                    )
                } else {
                    $("#content").show();
                    popTipShow.alert('提示', resp.msg, ['确 定'],
                        function(e) {
                            var button = $(e.target).attr('class');
                            if (button == 'ok') {
                                this.hide();
                            }
                        })
                }
            },
            error: function() {
                $(".loading").hide();
                webToast("网络不给力，请稍后再试", "middle", 2000);
            }
        })
    }
    //页面初始化
    //			function getOrderDetailById() {
    //				$.ajax({
    //					type: "post",
    //					url: host + activitycore + "/weekrob/getcountdown/" + actCode + "/" + sceneId + ".json?custid=" + userId,
    //					data: JSON.stringify({}),
    //					async: true,
    //					contentType: "application/json;charset=utf-8",
    //					success: function(resp) {
    //						if (resp.code == 200) {
    //							var dataTime = resp.data;
    //							var dataTwo = parseInt(resp.data);
    //							if (dataTime == '-1') {
    //								$('.product-tip').html("活动已结束,期待您的下次参与！");
    //							} else if (dataTime == '0') {
    //								$('.product-tip').html("活动已开始，爆抢进行中！");
    //							} else if (dataTwo > 0) {
    //								$('.product-tip').html("活动未开始，敬请期待！");
    //								//								var time = dataTwo;
    //								//								setTimeout(function() {
    //								//									location.reload();
    //								//								}, time);
    //								//								function timer(time) { //倒计时
    //								//									window.setInterval(function() {
    //								//										var day = 0,
    //								//											hour = 0,
    //								//											minute = 0,
    //								//											second = 0;
    //								//										if (time > 0) {
    //								//											day = Math.floor(time / (60 * 60 * 24));
    //								//											hour = Math.floor(time / (60 * 60)) - (day * 24);
    //								//											minute = Math.floor(time / 60) - (day * 24 * 60) - (hour * 60);
    //								//											second = Math.floor(time) - (day * 24 * 60 * 60) - (hour * 60 * 60) - (minute * 60)
    //								//										}
    //								//										if (minute <= 9) {
    //								//											minute = "0" + minute;
    //								//										}
    //								//										if (second <= 9) {
    //								//											second = "0" + second;
    //								//										}
    //								//										$('.product-tip span').html(day + '天' + hour + '时' + minute + '分' + second + '秒');
    //								//										time--;
    //								//									}, 1000)
    //								//								};
    //								//								timer(time);
    //							}
    //						} else if (resp.code == 414) {
    //							isPastDue();
    //						} else {
    //							popTipShow.alert('提示', resp.msg, ['确 定'],
    //								function(e) {
    //									var button = $(e.target).attr('class');
    //									if (button == 'ok') {
    //										this.hide();
    //									}
    //								})
    //						}
    //					},
    //					error: function() {
    //						webToast("网络不给力，请稍后再试", "middle", 2000);
    //					}
    //				});
    //			}
    //页面元素拼接
    function appendOrderDetail(obj) {
        var html = "";
        html += '<div class="row"><div class="col col-33"><img src="' + obj.url + '" style="width: 80%;margin-left: 10%;"/></div>';
        html += '<div class="col col-67"><p>爆品名称:' + obj.name + '</p><p> 市场参考价:' + obj.price + '元</p><p>抢兑数量：' + obj.goodsCount + '</p>';
        html += '<p>开场时间:' + obj.beginTime + '</p>';
        html += '</div></div>';
        $("#productBuy").html(html);
    }
    //点击切换验证码
    function changeCode() {
        var imgNode = document.getElementById("vimg");
        imgNode.src = host + activitycore + "/vcode/getVCode/" + actCode + "/" + sceneId + "/" + userId + ".json?t=" + Math.random() + "&custid=" + userId; // 防止浏览器缓存的问题
    }
</script>
</body>

</html>